<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow Pro - TDAH no Escrit√≥rio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #48bb78, #38a169);
            --warning-gradient: linear-gradient(135deg, #ed8936, #dd6b20);
            --info-gradient: linear-gradient(135deg, #4299e1, #3182ce);
            --danger-gradient: linear-gradient(135deg, #f56565, #e53e3e);
            --hyperfocus-gradient: linear-gradient(135deg, #dc2626, #b91c1c);
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e2e8f0;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-hover: 0 15px 40px rgba(0,0,0,0.15);
        }
        [data-theme="dark"] {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #cbd5e0;
            --border-color: #4a5568;
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
            --shadow-hover: 0 15px 40px rgba(0,0,0,0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        /* Modo Foco */
        body.focus-mode .header,
        body.focus-mode .clock-container,
        body.focus-mode .tabs,
        body.focus-mode #reportsTab,
        body.focus-mode #settingsTab,
        body.focus-mode #taskListSection,
        body.focus-mode .legend,
        body.focus-mode #todayTasks {
            display: none !important;
        }
        body.focus-mode .container {
            padding: 5vh 0;
            max-width: 800px;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: var(--text-primary); margin-bottom: 20px; position: relative; }
        .theme-toggle { position: absolute; top: 0; right: 0; background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 50%; width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2em; transition: all 0.3s ease; }
        .theme-toggle:hover { transform: scale(1.1); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .clock-container { text-align: center; margin-bottom: 15px; }
        .big-clock { font-size: 2em; font-weight: bold; color: var(--text-primary); margin-bottom: 5px; }
        .date-display { font-size: 1em; color: var(--text-secondary); }
        .github-status { position: absolute; top: 0; left: 0; display: flex; align-items: center; gap: 10px; padding: 10px 15px; background: var(--bg-secondary); border-radius: 25px; font-size: 0.9em; border: 2px solid var(--border-color); }
        .github-status.synced { border-color: #48bb78; color: #48bb78; }
        .github-status.error { border-color: #f56565; color: #f56565; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .card { background: var(--bg-secondary); border-radius: 15px; padding: 25px; box-shadow: var(--shadow); transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid var(--border-color); }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
        .card h2 { margin-bottom: 20px; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
        .current-task { background: var(--success-gradient); color: white; text-align: center; min-height: 280px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .current-task.paused { background: var(--warning-gradient); }
        .current-task.break { background: var(--info-gradient); }
        .current-task.hyperfocus { background: var(--hyperfocus-gradient); }
        .current-task.overtime { background: var(--danger-gradient); }
        .cycle-info { position: absolute; top: 20px; right: 20px; text-align: right; font-size: 0.9em; opacity: 0.9; }
        .cycle-label { font-weight: bold; margin-bottom: 2px; }
        .cycle-value { font-size: 1.1em; }
        .task-energy { position: absolute; top: 55px; right: 20px; font-size: 1.5em; }
        .timer-display { font-size: 5em; font-weight: bold; margin: 15px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .timer-display.overtime { color: #ff0000; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .task-title { font-size: 2.8em; font-weight: bold; margin-bottom: 15px; opacity: 0.95; line-height: 1.2; padding-right: 120px; }
        .task-info { opacity: 0.8; margin-bottom: 20px; font-size: 1.1em; }
        .controls { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn { background: #4299e1; color: white; border: none; padding: 15px 25px; border-radius: 25px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn.primary { background: #48bb78; } .btn.primary:hover { background: #38a169; }
        .btn.danger { background: #f56565; } .btn.danger:hover { background: #e53e3e; }
        .btn.warning { background: #ed8936; } .btn.warning:hover { background: #dd6b20; }
        .btn.secondary { background: #718096; } .btn.secondary:hover { background: #4a5568; }
        .btn.hyper { background: #dc2626; } .btn.hyper:hover { background: #b91c1c; }
        .task-list-section { margin-top: 30px; transition: all 0.3s ease; }
        .task-list-section.hidden { display: none; }
        .task-list { max-height: 600px; overflow-y: auto; }
        .task-item { display: flex; align-items: flex-start; padding: 20px; border-radius: 15px; margin-bottom: 15px; background: var(--bg-secondary); transition: all 0.3s ease; cursor: pointer; border: 2px solid var(--border-color); position: relative; }
        .task-item:hover { background: var(--bg-primary); transform: translateX(5px); box-shadow: var(--shadow); }
        .task-item.selected { background: linear-gradient(135deg, #fef3c7, #fde68a); border-color: #f59e0b; box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
        .task-item.planned-today { border-left: 5px solid #f59e0b; }
        .task-item.dragging { opacity: 0.5; border-style: dashed; } /* Estilo para Drag & Drop */
        .task-emoji { font-size: 2em; margin-right: 15px; margin-top: 2px; }
        .task-content { flex: 1; }
        .task-name { font-weight: 600; margin-bottom: 8px; color: var(--text-primary); font-size: 1.1em; }
        .task-meta { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px; }
        .task-progress { font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px; }
        .progress-bar-small { width: 100%; height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .progress-fill-small { height: 100%; background: #4299e1; transition: width 0.3s ease; }
        .task-tags { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .tag { background: var(--border-color); color: var(--text-secondary); padding: 4px 10px; border-radius: 15px; font-size: 0.8em; }
        .notification { position: fixed; top: 20px; right: 20px; background: #48bb78; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transform: translateX(400px); transition: transform 0.3s ease; z-index: 1001; max-width: 300px; }
        .notification.show { transform: translateX(0); }
        .notification.error { background: #f56565; }
        .notification.warning { background: #ed8936; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.3s ease; color: var(--text-secondary); }
        .tab.active { color: var(--text-primary); border-bottom-color: #4299e1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .filter-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { background: var(--bg-primary); border: 2px solid var(--border-color); color: var(--text-secondary); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; }
        .filter-btn:hover { background: var(--border-color); }
        .filter-btn.active { background: #4299e1; color: white; border-color: #4299e1; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-state .emoji { font-size: 4em; margin-bottom: 20px; display: block; }
        
        /* Subtarefas */
        .subtasks-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .subtask-item { display: flex; align-items: center; gap: 10px; padding: 5px 0; font-size: 0.9em; }
        .subtask-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .subtask-item label { flex: 1; color: var(--text-secondary); }
        .subtask-item input[type="checkbox"]:checked + label { text-decoration: line-through; color: var(--text-primary); }
        .add-subtask-form { display: flex; gap: 10px; margin-top: 10px; }
        .add-subtask-input { flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-primary); }
        
        /* Gamifica√ß√£o */
        .gamification-stats { text-align: center; margin-bottom: 20px; }
        .points-display { font-size: 2.5em; font-weight: bold; color: var(--primary-gradient); background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .achievements-list h3 { margin-bottom: 10px; }
        .achievement { background: var(--bg-primary); padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-color); opacity: 0.5; }
        .achievement.unlocked { opacity: 1; border-left: 4px solid #48bb78; }
        .achievement-title { font-weight: bold; }
        .achievement-desc { font-size: 0.9em; color: var(--text-secondary); }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); }
        .form-control { width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1em; background: var(--bg-primary); color: var(--text-primary); transition: border-color 0.3s ease; }
        .form-control:focus { outline: none; border-color: #4299e1; box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1); }
        .color-picker { display: flex; gap: 12px; margin-top: 10px; }
        .color-option { width: 45px; height: 45px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; font-size: 1.4em; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; background: var(--bg-primary); }
        .color-option:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .color-option.selected { border-color: #4299e1; transform: scale(1.1); }
        
        .legend { background: var(--bg-secondary); border-radius: 10px; padding: 20px; margin-top: 20px; border: 1px solid var(--border-color); }
        .legend h3 { margin-bottom: 15px; color: var(--text-primary); }
        .legend-item { display: flex; align-items: center; margin-bottom: 10px; font-size: 0.9em; color: var(--text-secondary); }
        .legend-emoji { font-size: 1.3em; margin-right: 12px; }
        
        .today-tasks { margin-top: 20px; padding: 15px; background: var(--bg-primary); border-radius: 10px; border: 1px solid var(--border-color); }
        .today-tasks h3 { margin-bottom: 10px; color: var(--text-primary); font-size: 1em; }
        .today-task-item { display: flex; align-items: center; padding: 8px 12px; margin-bottom: 8px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; }
        .today-task-item:hover { background: var(--border-color); transform: translateX(3px); }
        .today-task-item.selected { border-color: #f59e0b; background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .today-task-emoji { font-size: 1.2em; margin-right: 10px; }
        .today-task-name { flex: 1; font-size: 0.9em; font-weight: 600; color: var(--text-primary); }
        .today-task-time { font-size: 0.8em; color: var(--text-secondary); margin-left: 10px; }
        
        .task-actions-bar {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }
        .action-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-btn:hover { background: rgba(255,255,255,0.3); }

        .stat-card { background: var(--bg-primary); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid var(--border-color); }
        .stat-value { font-size: 2em; font-weight: bold; color: #4299e1; display: block; }
        .stat-label { font-size: 0.9em; color: var(--text-secondary); margin-top: 8px; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="github-status" id="githubStatus">
                <i class="fab fa-github"></i>
                <span id="statusText">Conectando...</span>
            </div>
            <button class="theme-toggle" id="themeToggle" onclick="Settings.toggleTheme()">
                <i class="fas fa-moon"></i>
            </button>
            <h1>üß† FocusFlow Pro</h1>
            <p>Gerenciador de tarefas personalizado para TDAH no escrit√≥rio</p>
        </div>
        <div class="clock-container">
            <div class="big-clock" id="bigClock">00:00</div>
            <div class="date-display" id="dateDisplay">Carregando...</div>
        </div>
        <div class="tabs">
            <div class="tab active" onclick="UI.switchTab('tasks', event)">üìã Tarefas</div>
            <div class="tab" onclick="UI.switchTab('reports', event)">üìä Relat√≥rios</div>
            <div class="tab" onclick="UI.switchTab('settings', event)">‚öôÔ∏è Configura√ß√µes</div>
        </div>
        
        <div id="tasksTab" class="tab-content active">
            <div class="task-focus-section">
                <div class="card current-task" id="currentTaskCard">
                    <div class="task-actions-bar">
                        <button class="action-btn" onclick="UI.toggleTaskList()" id="toggleTasksBtn" title="Mostrar/Esconder Lista (T)">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn" onclick="UI.toggleFocusMode()" id="toggleFocusBtn" title="Modo Foco (F)">
                            <i class="fas fa-bullseye"></i>
                        </button>
                    </div>
                    
                    <div id="noTaskState" class="empty-state">
                        <span class="emoji">üéØ</span>
                        <h3>Nenhuma tarefa ativa</h3>
                        <p>Selecione uma tarefa ou crie uma nova (Atalho: N)</p>
                    </div>
                    
                    <div id="activeTaskState" style="display: none;">
                        <div class="cycle-info">
                            <div class="cycle-label">CICLO</div>
                            <div class="cycle-value" id="cycleValue">1/1</div>
                        </div>
                        <div class="task-energy" id="taskEnergyDisplay">üü† üòä</div>
                        <div class="task-title" id="currentTaskTitle"></div>
                        <div class="task-info" id="currentTaskInfo"></div>
                        <div class="timer-display" id="timerDisplay">25:00</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="controls" id="taskControls"></div>
                    </div>
                </div>
                <div class="today-tasks" id="todayTasks">
                    <h3>üìÖ Tarefas de Hoje</h3>
                    <div id="todayTasksList"></div>
                </div>
            </div>
            <div class="task-list-section hidden" id="taskListSection">
                <div class="card">
                    <h2>üìã Minhas Tarefas</h2>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="Tasks.filterTasks('all', event)">Todas</button>
                        <button class="filter-btn" onclick="Tasks.filterTasks('today', event)">Para Hoje</button>
                        <button class="filter-btn" onclick="Tasks.filterTasks('todo', event)">A Fazer</button>
                        <button class="filter-btn" onclick="Tasks.filterTasks('doing', event)">Em Andamento</button>
                        <button class="filter-btn" onclick="Tasks.filterTasks('completed', event)">Conclu√≠das</button>
                    </div>
                    <div class="task-list" id="taskList"></div>
                    <button class="btn primary" onclick="UI.showNewTaskForm()" style="width: 100%; margin-top: 20px;">
                        ‚ûï Nova Tarefa (N)
                    </button>
                </div>
            </div>
            <div class="legend">
                <!-- ... (c√≥digo da legenda inalterado) ... -->
            </div>
        </div>
        
        <div id="reportsTab" class="tab-content">
             <div class="card">
                <h2>üìä Relat√≥rios e Gamifica√ß√£o</h2>
                <div class="gamification-stats">
                    <h3>Sua Pontua√ß√£o</h3>
                    <div class="points-display" id="pointsDisplay">0</div>
                    <p>Pontos por tarefas e foco!</p>
                </div>
                <div class="report-grid">
                    <div class="stat-card">
                        <span class="stat-value" id="dailyFocusTime">0</span>
                        <div class="stat-label">Minutos focados hoje</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="dailyCompleted">0</span>
                        <div class="stat-label">Tarefas conclu√≠das</div>
                    </div>
                    <!-- ... mais stats ... -->
                </div>
                 <div class="achievements-list">
                     <h3>üèÜ Conquistas</h3>
                     <div id="achievementsContainer"></div>
                 </div>
            </div>
        </div>

        <div id="settingsTab" class="tab-content">
            <!-- ... (c√≥digo das configura√ß√µes inalterado, apenas chamadas de fun√ß√£o atualizadas) ... -->
        </div>
    </div>

    <div id="newTaskModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); border-radius: 15px; padding: 30px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 25px; color: var(--text-primary);">‚ûï Nova Tarefa</h2>
            <div class="form-group">
                <label>T√≠tulo da Tarefa *</label>
                <input type="text" id="taskTitle" class="form-control" placeholder="Ex: Revisar proposta do projeto X">
            </div>
            <!-- ... (resto do modal com chamadas atualizadas) ... -->
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="btn primary" onclick="Tasks.saveTask()" style="flex: 1;">Salvar Tarefa</button>
                <button class="btn" onclick="UI.closeModal()" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>

    <script>
        // Service Worker Registration for Offline Mode
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker: Registered'))
                    .catch(err => console.log(`Service Worker: Error: ${err}`));
            });
        }
    </script>
    <script id="service-worker-script">
        const cacheName = 'focusflow-v1';
        const cacheAssets = [
            '/',
            '/index.html', // ou o nome do seu arquivo principal
        ];
        self.addEventListener('install', e => {
            e.waitUntil(
                caches.open(cacheName)
                    .then(cache => {
                        console.log('Service Worker: Caching Files');
                        cache.addAll(cacheAssets);
                    })
                    .then(() => self.skipWaiting())
            );
        });
        self.addEventListener('activate', e => {
            e.waitUntil(
                caches.keys().then(cacheNames => {
                    return Promise.all(
                        cacheNames.map(cache => {
                            if (cache !== cacheName) {
                                return caches.delete(cache);
                            }
                        })
                    );
                })
            );
        });
        self.addEventListener('fetch', e => {
            e.respondWith(
                fetch(e.request).catch(() => caches.match(e.request))
            );
        });
    </script>
    <script>
    // ==========================================
    //  APPLICATION STATE & UTILITIES
    // ==========================================
    
    let appState = {
        tasks: [],
        currentTask: null,
        timer: null,
        timeLeft: 0,
        isRunning: false,
        currentCycle: 1,
        totalCycles: 1,
        mode: 'focus', // 'focus', 'break', 'hyperfocus', 'overtime'
        currentFilter: 'all',
        taskListVisible: false,
        stats: {
            focusTime: 0,
            completedTasks: 0,
            points: 0,
            achievements: {
                firstTask: false,
                firstCycle: false,
                tenTasks: false,
            },
            dailyStats: {},
        },
        settings: {
            soundEnabled: true,
            pomodoroDuration: 25,
            breakDuration: 5,
            hyperfocusDuration: 45,
            theme: 'light',
        },
    };

    const achievementDefs = {
        firstTask: { title: 'Primeiro Passo', desc: 'Voc√™ completou sua primeira tarefa!' },
        firstCycle: { title: 'Focado!', desc: 'Voc√™ completou um ciclo de foco completo.' },
        tenTasks: { title: 'Produtividade em Pessoa', desc: 'Dez tarefas conclu√≠das. Incr√≠vel!' },
    };

    function generateId() {
        return Date.now() + Math.random().toString(36).substr(2, 9);
    }

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // ==========================================
    //  DATA MANAGEMENT MODULE
    // ==========================================
    const Data = {
        save: debounce(() => {
            localStorage.setItem('focusflow-data', JSON.stringify(appState));
            console.log("Data saved.");
        }, 1500),

        load: () => {
            const savedData = localStorage.getItem('focusflow-data');
            if (savedData) {
                appState = JSON.parse(savedData);
            }
        }
    };

    // ==========================================
    //  UI MODULE
    // ==========================================
    const UI = {
        updateClock: () => {
            const now = new Date();
            document.getElementById('bigClock').textContent = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('dateDisplay').textContent = now.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
        },
        
        showNotification: (message, type = 'success') => {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            setTimeout(() => notification.classList.remove('show'), 3000);
        },

        switchTab: (tabName, event) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.currentTarget.classList.add('active');
            if (tabName === 'reports') UI.updateReports();
        },

        toggleTaskList: () => {
            const taskListSection = document.getElementById('taskListSection');
            const toggleBtn = document.getElementById('toggleTasksBtn');
            appState.taskListVisible = !appState.taskListVisible;
            taskListSection.classList.toggle('hidden', !appState.taskListVisible);
            toggleBtn.innerHTML = appState.taskListVisible ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
        },
        
        toggleFocusMode: () => {
            document.body.classList.toggle('focus-mode');
        },
        
        // ... more UI functions like updateCurrentTaskDisplay, updateTaskList
    };

    // ==========================================
    //  TASK MANAGEMENT MODULE
    // ==========================================
    const Tasks = {
        saveTask: () => {
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) return UI.showNotification('O t√≠tulo √© obrigat√≥rio', 'error');

            const newTask = {
                id: generateId(),
                title,
                subtasks: [],
                // ... other properties
                status: 'todo',
                created: new Date().toISOString(),
            };
            appState.tasks.unshift(newTask);
            Data.save();
            UI.updateTaskList();
            UI.closeModal();
        },
        
        filterTasks: (filter, event) => {
            appState.currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            UI.updateTaskList();
        },
        
        selectTask: (taskId) => {
             // Logic to select a task, reset timer, etc.
        },
        
        completeTask: () => {
            if (!appState.currentTask) return;
            // ... logic to complete task
            
            Gamification.awardPoints(50); // Award points
            Gamification.checkAchievements('completeTask');
            Data.save();
            // ... update UI
        },
        
        toggleSubtask: (taskId, subtaskId) => {
            const task = appState.tasks.find(t => t.id === taskId);
            if (!task) return;
            const subtask = task.subtasks.find(st => st.id === subtaskId);
            if (!subtask) return;
            subtask.completed = !subtask.completed;
            Data.save();
            UI.updateTaskList();
        },

        addSubtask: (taskId, event) => {
            if (event.key !== 'Enter') return;
            const input = event.target;
            const title = input.value.trim();
            if (!title) return;

            const task = appState.tasks.find(t => t.id === taskId);
            if (task) {
                task.subtasks.push({ id: generateId(), title, completed: false });
                input.value = '';
                Data.save();
                UI.updateTaskList();
            }
        },
        // ... other task functions
    };
    
    // ==========================================
    //  TIMER MODULE
    // ==========================================
    const Timer = {
        start: () => {
            if (!appState.currentTask || appState.isRunning) return;
            appState.isRunning = true;
            // ... start timer logic
        },
        pause: () => {
            if (!appState.isRunning) return;
            appState.isRunning = false;
            // ... pause timer logic
        },
        toggle: () => {
            if (appState.isRunning) Timer.pause();
            else Timer.start();
        },
        // ... other timer functions
    };

    // ==========================================
    //  GAMIFICATION MODULE
    // ==========================================
    const Gamification = {
        awardPoints: (amount) => {
            appState.stats.points += amount;
            UI.updateReports();
        },
        checkAchievements: (action) => {
            if (action === 'completeTask') {
                if (!appState.stats.achievements.firstTask) {
                    appState.stats.achievements.firstTask = true;
                    UI.showNotification('üèÜ Conquista: Primeiro Passo!', 'success');
                }
                const completedCount = appState.tasks.filter(t => t.status === 'completed').length;
                if (completedCount >= 10 && !appState.stats.achievements.tenTasks) {
                    appState.stats.achievements.tenTasks = true;
                    UI.showNotification('üèÜ Conquista: Produtividade em Pessoa!', 'success');
                }
            }
            if (action === 'completeCycle') {
                if (!appState.stats.achievements.firstCycle) {
                    appState.stats.achievements.firstCycle = true;
                    UI.showNotification('üèÜ Conquista: Focado!', 'success');
                }
            }
            UI.updateAchievements();
        }
    };
    
    // ==========================================
    //  DRAG & DROP LOGIC
    // ==========================================
    const DragDrop = {
        draggedItemId: null,

        init: () => {
            const taskList = document.getElementById('taskList');
            taskList.addEventListener('dragstart', DragDrop.onDragStart);
            taskList.addEventListener('dragover', DragDrop.onDragOver);
            taskList.addEventListener('drop', DragDrop.onDrop);
        },

        onDragStart: (e) => {
            if (e.target.classList.contains('task-item')) {
                DragDrop.draggedItemId = e.target.dataset.taskId;
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => e.target.classList.add('dragging'), 0);
            }
        },

        onDragOver: (e) => {
            e.preventDefault();
        },
        
        onDrop: (e) => {
            e.preventDefault();
            const dropZone = e.target.closest('.task-item');
            if (!dropZone || dropZone.dataset.taskId === DragDrop.draggedItemId) return;
            
            const fromIndex = appState.tasks.findIndex(t => t.id === DragDrop.draggedItemId);
            const toIndex = appState.tasks.findIndex(t => t.id === dropZone.dataset.taskId);

            const [movedItem] = appState.tasks.splice(fromIndex, 1);
            appState.tasks.splice(toIndex, 0, movedItem);

            document.querySelector(`[data-task-id="${DragDrop.draggedItemId}"]`).classList.remove('dragging');
            Data.save();
            UI.updateTaskList();
        }
    };
    
    // ==========================================
    //  APPLICATION INITIALIZATION
    // ==========================================
    const App = {
        init: () => {
            Data.load();
            Settings.apply();
            UI.updateClock();
            setInterval(UI.updateClock, 1000 * 30); // Update clock every 30s
            UI.updateTaskList();
            UI.updateReports();
            App.setupEventListeners();
            DragDrop.init();
        },

        setupEventListeners: () => {
            document.addEventListener('keydown', (e) => {
                // Ignore shortcuts if typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                switch(e.key.toLowerCase()) {
                    case 'n':
                        e.preventDefault();
                        UI.showNewTaskForm();
                        break;
                    case ' ':
                        if (appState.currentTask) {
                            e.preventDefault();
                            Timer.toggle();
                        }
                        break;
                    case 'c':
                        if (appState.currentTask) {
                            e.preventDefault();
                            Tasks.completeTask();
                        }
                        break;
                    case 'f':
                         e.preventDefault();
                         UI.toggleFocusMode();
                        break;
                    case 'escape':
                        UI.closeModal();
                        UI.closeEditModal();
                        break;
                }
            });
        },
        // Forwarding functions to be accessible from HTML onclick
        showNewTaskForm: UI.showNewTaskForm,
        // ... other forwarded functions
    };

    // Initialize the app when the DOM is ready
    document.addEventListener('DOMContentLoaded', App.init);

    // Extend UI module with functions that depend on other modules
    Object.assign(UI, {
        updateTaskList: () => {
            const taskList = document.getElementById('taskList');
            let filteredTasks = appState.tasks; // Apply filter logic here

            if (filteredTasks.length === 0) {
                taskList.innerHTML = `<div class="empty-state">...</div>`;
                return;
            }
            
            taskList.innerHTML = filteredTasks.map(task => {
                const subtasksProgress = task.subtasks.length > 0 ? (task.subtasks.filter(st => st.completed).length / task.subtasks.length) * 100 : 0;
                
                return `
                    <div class="task-item" data-task-id="${task.id}" draggable="true" onclick="Tasks.selectTask('${task.id}')">
                        <div class="task-emoji">${task.color}</div>
                        <div class="task-content">
                            <div class="task-name">${task.title}</div>
                            <!-- ... other meta info ... -->
                            <div class="subtasks-section">
                                ${task.subtasks.map(st => `
                                    <div class="subtask-item">
                                        <input type="checkbox" id="st-${st.id}" ${st.completed ? 'checked' : ''} onchange="Tasks.toggleSubtask('${task.id}', '${st.id}')">
                                        <label for="st-${st.id}">${st.title}</label>
                                    </div>
                                `).join('')}
                                <div class="add-subtask-form">
                                    <input type="text" class="add-subtask-input" placeholder="Nova subtarefa + Enter" onkeydown="Tasks.addSubtask('${task.id}', event)">
                                </div>
                                ${task.subtasks.length > 0 ? `
                                <div class="progress-bar-small">
                                    <div class="progress-fill-small" style="width: ${subtasksProgress}%"></div>
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        },
        
        updateReports: () => {
            document.getElementById('pointsDisplay').textContent = appState.stats.points;
            // ... update other stats ...
            UI.updateAchievements();
        },
        
        updateAchievements: () => {
            const container = document.getElementById('achievementsContainer');
            container.innerHTML = Object.keys(achievementDefs).map(key => {
                const unlocked = appState.stats.achievements[key];
                const def = achievementDefs[key];
                return `
                    <div class="achievement ${unlocked ? 'unlocked' : ''}">
                        <div class="achievement-title">${def.title} ${unlocked ? '‚úîÔ∏è' : ''}</div>
                        <div class="achievement-desc">${def.desc}</div>
                    </div>
                `;
            }).join('');
        }
    });

    </script>
</body>
</html>
