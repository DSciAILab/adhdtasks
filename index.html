<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FocusFlow Pro</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,'Helvetica Neue',Arial;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#111827}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .header{color:#fff;text-align:center;margin:6px 0 10px}
  .title{font-size:28px;font-weight:800}
  .nav{display:flex;gap:10px;justify-content:center;margin:10px 0}
  .tab{background:rgba(255,255,255,.18);color:#fff;border:none;padding:10px 14px;border-radius:999px;font-weight:700;cursor:pointer}
  .tab.active{background:#fff;color:#4f46e5}
  .big-clock{font-size:68px;font-weight:900;color:#fff;text-align:center;line-height:1;margin:8px 0 2px;text-shadow:0 6px 30px rgba(0,0,0,.25)}
  .timer-wrap{text-align:center;margin:6px 0 14px}
  .timer-label{font-size:18px;color:#e5e7eb;opacity:.9;margin-bottom:6px}
  .timer-value{font-size:80px;font-weight:900;line-height:1}
  .timer-value.focus{color:#16a34a}
  .timer-value.break{color:#f59e0b}
  .timer-value.idle{color:#e5e7eb}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:18px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:#fff;border-radius:16px;padding:18px;box-shadow:0 12px 40px rgba(0,0,0,.10)}
  .card h2{font-size:18px;color:#334155;margin-bottom:12px;display:flex;gap:8px;align-items:center}
  .progress{width:100%;height:8px;background:#eef2ff;border-radius:999px;overflow:hidden;margin:12px 0}
  .progress > div{height:100%;background:#4f46e5;width:0%}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{background:#3b82f6;color:#fff;border:none;padding:11px 16px;border-radius:999px;font-weight:800;cursor:pointer}
  .btn:hover{filter:brightness(.95)}
  .btn.primary{background:#22c55e}.btn.secondary{background:#6366f1}.btn.danger{background:#ef4444}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .metrics{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:12px}
  @media(max-width:980px){.metrics{grid-template-columns:repeat(2,1fr)}}
  .stat{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:10px;text-align:center}
  .stat .v{font-weight:900}
  .list{max-height:520px;overflow:auto}
  .item{display:flex;align-items:center;gap:10px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-bottom:10px;cursor:pointer}
  .item:hover{background:#f1f5f9}
  .item.sel{background:#ecfeff;border-color:#06b6d4}
  .emoji{font-size:22px}
  .grow{flex:1}
  .muted{color:#6b7280}
  .legend{background:rgba(255,255,255,.9);border-radius:12px;padding:12px;margin-top:10px}
  .legend div{display:flex;gap:8px;align-items:center}
  .toast{position:fixed;right:18px;top:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 14px 36px rgba(0,0,0,.25);opacity:0;transform:translateY(-10px);transition:.25s;z-index:2000}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.success{background:#16a34a}.toast.warn{background:#f59e0b}.toast.error{background:#ef4444}
  .tag{display:inline-flex;gap:6px;align-items:center;background:#eef2ff;color:#4f46e5;border-radius:999px;padding:6px 10px;font-weight:700}
  .order{display:flex;gap:6px;align-items:center}
  .order .arrow{background:#e5e7eb;border:none;border-radius:8px;padding:6px 8px;cursor:pointer;font-weight:900}
  .pill{background:#e5e7eb;border-radius:999px;padding:4px 8px;font-size:12px}
  .tabs2{display:flex;gap:8px;margin-bottom:10px}
  .t2{background:#eef2ff;border:none;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700;color:#4f46e5}
  .t2.active{background:#4f46e5;color:#fff}
  .input,.select,.textarea{width:100%;border:2px solid #e5e7eb;border-radius:10px;padding:10px 12px}
  .textarea{min-height:80px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:980px){.grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">🧠 FocusFlow Pro</div>
  </div>

  <!-- Navegação -->
  <div class="nav">
    <button id="tabHoje" class="tab active">🏠 Hoje</button>
    <button id="tabTarefas" class="tab">📋 Tarefas</button>
  </div>

  <!-- Relógio sempre visível -->
  <div id="bigClock" class="big-clock">00:00:00</div>

  <!-- Cronômetro -->
  <div class="timer-wrap">
    <div id="timerLabel" class="timer-label">Parado</div>
    <div id="timerValue" class="timer-value idle">00:00</div>
  </div>

  <!-- Página Hoje -->
  <div id="pageHoje">
    <div class="grid">
      <!-- Tarefa atual -->
      <div class="card">
        <h2>🎯 Tarefa atual</h2>
        <div id="noTask" class="muted" style="text-align:center;padding:12px">Selecione uma tarefa “Planejada para hoje” ao lado</div>
        <div id="taskCard" style="display:none">
          <div class="row" style="justify-content:space-between">
            <div id="taskTitle" style="font-weight:800"></div>
            <div id="taskCycle" class="pill">Ciclo 1/1</div>
          </div>
          <div id="taskMeta" class="muted" style="margin-top:6px"></div>
          <div class="progress"><div id="progressFill"></div></div>
          <div class="controls">
            <button id="btnStart" class="btn primary">▶️ Iniciar</button>
            <button id="btnComplete" class="btn secondary">✅ Concluir</button>
            <button id="btnCancel" class="btn danger">✖️ Cancelar</button>
          </div>
          <div class="metrics">
            <div class="stat"><div class="v" id="m_done">0 min</div><div class="muted">Feito (foco)</div></div>
            <div class="stat"><div class="v" id="m_plan">0 min</div><div class="muted">Planejado</div></div>
            <div class="stat"><div class="v" id="m_left">0 min</div><div class="muted">Restante</div></div>
            <div class="stat"><div class="v" id="m_pcount">0</div><div class="muted">Pausas</div></div>
            <div class="stat"><div class="v" id="m_pmins">0 min</div><div class="muted">Tempo em pausas</div></div>
          </div>
        </div>
      </div>

      <!-- Planejadas para hoje (máx. 3) -->
      <div class="card">
        <h2>🗓️ Planejadas para hoje</h2>
        <div id="plannedList" class="list"></div>
        <div class="legend">
          <div><span>🔴</span> Conectado a outro humano</div>
          <div><span>🟠</span> Melhor que faça</div>
          <div><span>🟣</span> Me fazem bem (máx. 1/dia)</div>
          <div><span>🟢</span> Seria legal</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Página Tarefas -->
  <div id="pageTarefas" style="display:none">
    <div class="card">
      <h2>➕ Nova tarefa</h2>
      <div class="grid2">
        <div>
          <label>Título *</label>
          <input id="f_title" class="input" placeholder="Ex.: Finalizar relatório mensal"/>
        </div>
        <div>
          <label>Estimativa (min)</label>
          <input id="f_est" type="number" class="input" value="50" min="5" step="5"/>
        </div>
        <div>
          <label>Descrição</label>
          <textarea id="f_desc" class="textarea" placeholder="Detalhes..."></textarea>
        </div>
        <div>
          <label>Prioridade</label>
          <select id="f_pri" class="select"><option>Alta</option><option selected>Média</option><option>Baixa</option></select>
        </div>
        <div>
          <label>Energia</label>
          <select id="f_energy" class="select"><option>Alta</option><option selected>Média</option><option>Baixa</option></select>
        </div>
        <div>
          <label>Cor/Tipo</label>
          <select id="f_color" class="select"><option>🔴</option><option selected>🟠</option><option>🟣</option><option>🟢</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" onclick="createTask()">Salvar</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h2>📋 Gerenciar</h2>
      <div class="tabs2">
        <button id="fltAll" class="t2 active">A fazer / Em andamento</button>
        <button id="fltCompleted" class="t2">Concluídas</button>
        <button id="fltCancelled" class="t2">Canceladas</button>
      </div>
      <div id="manageList" class="list"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast">OK</div>

<script>
/* ===== Estado/Persistência ===== */
const STORAGE='focusflow-v6';
const POMO_FOCUS=25*60, POMO_BREAK=5*60;
let S={
  tasks:[],         // {id,title,desc,color,priority,energy,estimate,status,created,focusMinutes,breakMinutes,breakCount,startedDates:[],plannedToday:false,orderToday:0}
  current:null,     // id da tarefa selecionada (aba Hoje)
  mode:'idle',      // idle|focus|break
  timer:null,
  timeLeft:0,       // countdown do foco
  breakElapsed:0,   // countup da pausa (com countdown visual até 0 e depois overrun)
  breakPlanned:POMO_BREAK,
  breakBeeped:false,
  cycle:1
};
function save(){ localStorage.setItem(STORAGE, JSON.stringify({...S,timer:null})) }
function load(){ const r=localStorage.getItem(STORAGE); if(r){ try{ Object.assign(S, JSON.parse(r)); }catch{} } renderAll(); }

/* ===== Util ===== */
const $=sel=>document.querySelector(sel);
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8) }
function mmss(s){ s=Math.trunc(s); const m=String(Math.floor(Math.abs(s)/60)).padStart(2,'0'); const sc=String(Math.abs(s)%60).padStart(2,'0'); return (s<0?'-':'')+`${m}:${sc}` }
function mmssOver(breakPlanned, elapsed){ const remain = breakPlanned - elapsed; return remain>=0 ? mmss(remain) : '+'+mmss(-remain) }
function toast(msg,type='success'){ const el=$("#toast"); el.textContent=msg; el.className=`toast show ${type}`; setTimeout(()=>el.classList.remove('show'),2200); }
function todayStr(){ return new Date().toDateString() }
function hasPurpleStartedToday(excludeId=null){
  return S.tasks.some(t => t.color==='🟣' && t.id!==excludeId && Array.isArray(t.startedDates) && t.startedDates.some(d => new Date(d).toDateString()===todayStr()));
}
function getCurrent(){ return S.tasks.find(t=>t.id===S.current)||null }

/* ===== Relógio HH:MM:SS ===== */
function tickClock(){ const n=new Date(),h=String(n.getHours()).padStart(2,'0'),m=String(n.getMinutes()).padStart(2,'0'),s=String(n.getSeconds()).padStart(2,'0'); $("#bigClock").textContent=`${h}:${m}:${s}` }
setInterval(tickClock,1000); tickClock();

/* ===== Navegação ===== */
$("#tabHoje").onclick=()=>{ $("#tabHoje").classList.add('active'); $("#tabTarefas").classList.remove('active'); $("#pageHoje").style.display='block'; $("#pageTarefas").style.display='none'; }
$("#tabTarefas").onclick=()=>{ $("#tabTarefas").classList.add('active'); $("#tabHoje").classList.remove('active'); $("#pageHoje").style.display='none'; $("#pageTarefas").style.display='block'; renderManage(); }

/* ===== Timer Engine ===== */
function clearTimer(){ if(S.timer){ clearInterval(S.timer); S.timer=null; } }
function startFocus(){
  S.mode='focus'; S.timeLeft=POMO_FOCUS; clearTimer();
  S.timer=setInterval(()=>{
    S.timeLeft--;
    if(S.timeLeft<=0){
      clearTimer();
      // Fim do foco → registra 25 min e entra no break
      const t=getCurrent(); if(t){ t.focusMinutes=(t.focusMinutes||0)+25; save(); }
      playBeep(); startBreak();
    }
    renderTimer();
  },1000);
  renderTimer();
}
function startBreak(){
  S.mode='break'; S.breakElapsed=0; S.breakPlanned=POMO_BREAK; S.breakBeeped=false; clearTimer();
  S.timer=setInterval(()=>{
    S.breakElapsed++;
    // Beep quando “atinge” o planejado; continua em overrun
    if(!S.breakBeeped && S.breakElapsed>=S.breakPlanned){ playBeep(); S.breakBeeped=true; }
    renderTimer();
  },1000);
  renderTimer();
}
function closeBreakAndNextCycle(){
  const t=getCurrent();
  if(t){
    const mins=Math.ceil((S.breakElapsed||0)/60);
    t.breakMinutes=(t.breakMinutes||0)+mins;
    t.breakCount=(t.breakCount||0)+1;
    save();
  }
  S.cycle+=1; startFocus();
}
function stopAll(){ clearTimer(); S.mode='idle'; S.timeLeft=0; S.breakElapsed=0; renderTimer(); }
function playBeep(){ try{ const C=new (window.AudioContext||window.webkitAudioContext)(),o=C.createOscillator(),g=C.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(C.destination); g.gain.setValueAtTime(.001,C.currentTime); g.gain.exponentialRampToValueAtTime(.2,C.currentTime+.01); o.start(); o.stop(C.currentTime+.22); }catch{} }

/* ===== Ações do Botão Principal =====
   - idle→focus: iniciar (regra roxa)
   - break→focus: fecha pausa, soma tempo e inicia novo ciclo
   - focus→interromper: encerra foco, soma tempo decorrido e volta a idle
*/
function onStartClick(){
  const t=getCurrent(); if(!t) return;

  if(S.mode==='focus'){
    // Interromper/Pausar ciclo: registrar tempo decorrido deste foco e voltar a idle
    const decorrido = POMO_FOCUS - S.timeLeft; // seg
    const addMin = Math.max(0, Math.ceil(decorrido/60));
    if(addMin>0){ t.focusMinutes=(t.focusMinutes||0)+addMin; }
    stopAll(); toast('⏸️ Ciclo interrompido. Você pode iniciar novamente quando quiser.','warn');
    save(); renderAll(); return;
  }

  // Regras antes de iniciar Foco
  const startedTodayThis = (t.startedDates||[]).some(d => new Date(d).toDateString()===todayStr());
  if(t.color==='🟣' && !startedTodayThis && hasPurpleStartedToday(t.id)){
    toast('⚠️ Já existe tarefa roxa iniciada hoje. Retome a mesma ou deixe para amanhã.','warn'); return;
  }

  // Se está em break → fechar pausa e iniciar novo ciclo
  if(S.mode==='break'){ closeBreakAndNextCycle(); renderAll(); return; }

  // idle → iniciar foco
  t.status='doing'; t.startedDates=t.startedDates||[]; t.startedDates.push(new Date().toISOString()); save();
  startFocus(); toast(`⏰ Foco iniciado (ciclo ${S.cycle})`);
}

/* ===== CRUD Tarefas / Planejar Hoje ===== */
function createTask(){
  const title=$("#f_title").value.trim(); if(!title){ toast('Informe um título','error'); return; }
  const est=parseInt($("#f_est").value)||25;
  const t={ id:uid(), title, desc:$("#f_desc").value.trim(), color:$("#f_color").value, priority:$("#f_pri").value, energy:$("#f_energy").value,
            estimate:est, status:'todo', created:new Date().toISOString(),
            focusMinutes:0, breakMinutes:0, breakCount:0, startedDates:[], plannedToday:false, orderToday:0 };
  S.tasks.unshift(t); save(); $("#f_title").value=''; $("#f_desc").value=''; $("#f_est").value=50; renderManage(); toast('✅ Tarefa criada!');
}
function selectPlanned(id, planned){
  const t=S.tasks.find(x=>x.id===id); if(!t) return;
  t.plannedToday=planned;
  // dar ordem sequencial ao adicionar
  if(planned){ t.orderToday = 1 + Math.max(0, ...S.tasks.filter(z=>z.plannedToday).map(z=>z.orderToday||0)); }
  save(); renderPlanned(); renderManage();
}
function movePlanned(id, delta){
  const list = S.tasks.filter(t=>t.plannedToday).sort((a,b)=>(a.orderToday||0)-(b.orderToday||0));
  const idx = list.findIndex(t=>t.id===id); if(idx<0) return;
  const swapIdx = idx+delta; if(swapIdx<0 || swapIdx>=list.length) return;
  const a=list[idx], b=list[swapIdx];
  const tmp=a.orderToday; a.orderToday=b.orderToday; b.orderToday=tmp;
  save(); renderPlanned();
}
function selectCurrent(id){ S.current=id; S.cycle=1; stopAll(); renderAll(); }

/* ===== Render Hoje ===== */
function renderTimer(){
  const label=$("#timerLabel"), value=$("#timerValue"), bar=$("#progressFill");
  if(S.mode==='focus'){
    label.textContent='Foco'; value.className='timer-value focus'; value.textContent=mmss(S.timeLeft);
    bar.style.width=`${(1 - S.timeLeft/POMO_FOCUS)*100}%`;
  } else if(S.mode==='break'){
    label.textContent='Intervalo'; value.className='timer-value break';
    value.textContent = mmssOver(S.breakPlanned, S.breakElapsed); // countdown até 0, depois +overrun
    const p=Math.min(1, S.breakElapsed/S.breakPlanned); bar.style.width=`${p*100}%`;
  } else {
    label.textContent='Parado'; value.className='timer-value idle'; value.textContent='00:00'; bar.style.width='0%';
  }
}
function renderPlanned(){
  const el=$("#plannedList");
  const today=S.tasks.filter(t=>t.plannedToday).sort((a,b)=>(a.orderToday||0)-(b.orderToday||0)).slice(0,3);
  if(!today.length){ el.innerHTML='<div class="muted" style="text-align:center;padding:12px">Sem tarefas planejadas. Marque-as na aba “Tarefas”.</div>'; return; }
  el.innerHTML = today.map((t,i)=>`
    <div class="item ${S.current===t.id?'sel':''}">
      <div class="emoji">${t.color}</div>
      <div class="grow">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">${i+1}. ${t.title}</div>
          <div class="order">
            <button class="arrow" onclick="movePlanned('${t.id}',-1)">▲</button>
            <button class="arrow" onclick="movePlanned('${t.id}',+1)">▼</button>
          </div>
        </div>
        <div class="muted">${t.priority} • ${t.energy} • ~${t.estimate}min ${t.status==='doing'?'• Em andamento':''}</div>
      </div>
      <button class="btn" onclick="selectCurrent('${t.id}')">🎯 Focar</button>
    </div>
  `).join('');
}
function renderCurrent(){
  const card=$("#taskCard"), none=$("#noTask"), t=getCurrent();
  if(!t){ none.style.display='block'; card.style.display='none'; renderTimer(); return; }
  none.style.display='none'; card.style.display='block';
  $("#taskTitle").textContent=`${t.color} ${t.title}`;
  const plannedCycles = Math.max(1, Math.ceil((t.estimate||25)/25));
  $("#taskCycle").textContent=`Ciclo ${S.cycle}/${plannedCycles}`;
  $("#taskMeta").textContent=`${t.priority} • ${t.energy}`;
  // Botão principal (muda label conforme modo)
  const btn=$("#btnStart");
  btn.textContent = (S.mode==='focus') ? '⏸️ Interromper/Pausar ciclo' : (S.mode==='break' ? '▶️ Iniciar novo ciclo' : `▶️ Iniciar ciclo ${S.cycle}`);
  btn.onclick=onStartClick;
  $("#btnComplete").onclick=()=>{ completeTask(); };
  $("#btnCancel").onclick=()=>{ cancelTask(); };
  // Métricas
  const done=t.focusMinutes||0, plan=t.estimate||0, left=Math.max(0, plan-done);
  $("#m_done").textContent=`${done} min`; $("#m_plan").textContent=`${plan} min`; $("#m_left").textContent=`${left} min`;
  $("#m_pcount").textContent=`${t.breakCount||0}`; $("#m_pmins").textContent=`${t.breakMinutes||0} min`;
  renderTimer();
}
function completeTask(){
  const t=getCurrent(); if(!t) return;
  if(S.mode==='focus'){ // somar foco parcial
    const decorrido = POMO_FOCUS - S.timeLeft;
    const addMin = Math.max(0, Math.ceil(decorrido/60));
    if(addMin>0){ t.focusMinutes=(t.focusMinutes||0)+addMin; }
  } else if(S.mode==='break'){ // fechar pausa antes
    const mins=Math.ceil((S.breakElapsed||0)/60);
    t.breakMinutes=(t.breakMinutes||0)+mins; t.breakCount=(t.breakCount||0)+1;
  }
  stopAll(); t.status='completed'; S.current=null; save(); renderAll(); toast('🎉 Tarefa concluída!');
}
function cancelTask(){
  const t=getCurrent(); if(!t) return;
  stopAll(); t.status='cancelled'; S.current=null; save(); renderAll(); toast('✖️ Tarefa cancelada');
}
function renderHoje(){ renderPlanned(); renderCurrent(); }

/* ===== Página Tarefas (inclui Concluídas) ===== */ 
let MANAGE_FILTER='open'; // open|completed|cancelled
$("#fltAll").onclick=()=>{MANAGE_FILTER='open'; setManageTabs(); renderManage();}
$("#fltCompleted").onclick=()=>{MANAGE_FILTER='completed'; setManageTabs(); renderManage();}
$("#fltCancelled").onclick=()=>{MANAGE_FILTER='cancelled'; setManageTabs(); renderManage();}
function setManageTabs(){
  $("#fltAll").classList.toggle('active', MANAGE_FILTER==='open');
  $("#fltCompleted").classList.toggle('active', MANAGE_FILTER==='completed');
  $("#fltCancelled").classList.toggle('active', MANAGE_FILTER==='cancelled');
}
function renderManage(){
  const el=$("#manageList");
  let items=S.tasks.slice();
  if(MANAGE_FILTER==='open'){ items=items.filter(t=>t.status==='todo'||t.status==='doing'); }
  if(MANAGE_FILTER==='completed'){ items=items.filter(t=>t.status==='completed'); }
  if(MANAGE_FILTER==='cancelled'){ items=items.filter(t=>t.status==='cancelled'); }
  if(!items.length){ el.innerHTML='<div class="muted" style="text-align:center;padding:12px">Nada aqui.</div>'; return; }
  el.innerHTML = items.map(t=>`
    <div class="item">
      <div class="emoji">${t.color}</div>
      <div class="grow">
        <div class="row" style="justify-content:space-between">
          <div style="font-weight:800">${t.title}</div>
          <div class="tag">${t.status}</div>
        </div>
        <div class="muted">${t.priority} • ${t.energy} • ~${t.estimate}min</div>
        <div class="row" style="margin-top:6px;gap:8px">
          <span class="muted">Planejada hoje:</span>
          <button class="btn" style="padding:6px 10px" onclick="selectPlanned('${t.id}', ${!t.plannedToday})">${t.plannedToday?'Remover':'Adicionar'}</button>
          ${t.plannedToday?`<span class="muted">ordem: ${t.orderToday||0}</span>`:''}
          ${t.status!=='completed' && t.status!=='cancelled' ? `<button class="btn" style="padding:6px 10px" onclick="selectCurrent('${t.id}')">🎯 Focar</button>`:''}
        </div>
      </div>
    </div>
  `).join('');
}

/* ===== Render geral ===== */
function renderAll(){
  renderHoje();
  if($("#pageTarefas").style.display!=='none'){ renderManage(); }
}

/* ===== Boot ===== */
window.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
